<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesan Tiket - Cinewix</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading...</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <span class="logo-icon">üé¨</span>
                <span class="logo-text">CINEWIX</span>
            </div>
            <ul class="nav-menu" id="navMenu">
                <!-- Navigation items will be populated by JavaScript -->
            </ul>
        </div>
    </nav>

    <!-- Booking Section -->
    <section class="booking-section">
        <div class="container">
            <div class="booking-container">
                <!-- Movie Info -->
                <div id="movieInfo" class="booking-movie-info">
                    <!-- Movie info will be loaded here -->
                </div>

                <!-- Booking Steps -->
                <div class="booking-steps">
                    <!-- Step 1: Select Showtime -->
                    <div id="step1" class="booking-step active">
                        <h3>1. Pilih Jadwal Tayang</h3>
                        <div class="showtime-selector">
                            <div class="form-group">
                                <label>Tanggal:</label>
                                <input type="date" id="showDate" class="form-control" min="">
                            </div>
                            <div class="form-group">
                                <label>Waktu:</label>
                                <select id="showTime" class="form-control">
                                    <option value="">Pilih waktu</option>
                                    <option value="12:00">12:00</option>
                                    <option value="14:30">14:30</option>
                                    <option value="17:00">17:00</option>
                                    <option value="19:30">19:30</option>
                                    <option value="21:00">21:00</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Studio:</label>
                                <select id="showStudio" class="form-control">
                                    <option value="">Pilih studio</option>
                                    <option value="Studio 1">Studio 1</option>
                                    <option value="Studio 2">Studio 2</option>
                                    <option value="Studio 3">Studio 3</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="goToStep2()" class="btn-next">Lanjutkan</button>
                    </div>

                    <!-- Step 2: Select Seats -->
                    <div id="step2" class="booking-step">
                        <h3>2. Pilih Kursi</h3>
                        <div class="screen">LAYAR</div>
                        <div id="seatsContainer" class="seats-container">
                            <!-- Seats will be generated here -->
                        </div>
                        <div class="seat-legend">
                            <div><span class="seat-box available"></span> Tersedia</div>
                            <div><span class="seat-box selected"></span> Dipilih</div>
                            <div><span class="seat-box booked"></span> Terpesan</div>
                        </div>
                        <div class="selected-seats-info">
                            <p>Kursi dipilih: <span id="selectedSeatsText">-</span></p>
                            <p>Total: <span id="totalPrice">Rp 0</span></p>
                        </div>
                        <div class="step-buttons">
                            <button onclick="goToStep1()" class="btn-back">Kembali</button>
                            <button onclick="goToStep3()" class="btn-next">Lanjutkan</button>
                        </div>
                    </div>

                    <!-- Step 3: Payment -->
                    <div id="step3" class="booking-step">
                        <h3>3. Pembayaran</h3>
                        <div class="booking-summary">
                            <h4>Ringkasan Pesanan</h4>
                            <div class="summary-item">
                                <span>Film:</span>
                                <span id="summaryMovie">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Tanggal & Waktu:</span>
                                <span id="summaryDateTime">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Studio:</span>
                                <span id="summaryStudio">-</span>
                            </div>
                            <div class="summary-item">
                                <span>Kursi:</span>
                                <span id="summarySeats">-</span>
                            </div>
                            <div class="summary-item total">
                                <span>Total Pembayaran:</span>
                                <span id="summaryTotal">Rp 0</span>
                            </div>
                        </div>
                        
                        <div class="payment-method">
                            <h4>Metode Pembayaran</h4>
                            <select id="paymentMethod" class="form-control">
                                <option value="transfer">Transfer Bank</option>
                                <option value="credit_card">Kartu Kredit</option>
                                <option value="e-wallet">E-Wallet</option>
                            </select>
                        </div>

                        <div class="step-buttons">
                            <button onclick="goToStep2()" class="btn-back">Kembali</button>
                            <button onclick="processBooking()" class="btn-primary">Bayar Sekarang</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="public/js/api.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');
        let currentMovie = null;
        let selectedSeats = [];
        const pricePerSeat = 50000;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!movieId) {
                window.location.href = 'movies.html';
                return;
            }

            // Check authentication first
            await userState.checkAuth();
            
            if (!userState.isAuthenticated) {
                showToast('Silakan login terlebih dahulu', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return;
            }

            await updateNavigation('movies');
            await loadMovieInfo();
            setMinDate();
        });

        async function loadMovieInfo() {
            showLoading('Memuat informasi film...');
            
            try {
                const result = await api.getMovie(movieId);
                
                hideLoading();
                
                if (result.success) {
                    currentMovie = result.movie;
                    displayMovieInfo();
                } else {
                    showToast('Gagal memuat informasi film', 'error');
                    setTimeout(() => {
                        window.location.href = 'movies.html';
                    }, 1500);
                }
            } catch (error) {
                hideLoading();
                showToast('Terjadi kesalahan', 'error');
                console.error('Load movie error:', error);
            }
        }

        function displayMovieInfo() {
            const container = document.getElementById('movieInfo');
            container.innerHTML = `
                <div class="movie-info-card">
                    <h2>${currentMovie.title}</h2>
                    <p>${currentMovie.genre.join(', ')} ‚Ä¢ ${currentMovie.duration} menit ‚Ä¢ ‚≠ê ${currentMovie.rating}/10</p>
                </div>
            `;
        }

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('showDate').min = today;
            document.getElementById('showDate').value = today;
        }

        function goToStep1() {
            document.querySelectorAll('.booking-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
        }

        async function goToStep2() {
            const date = document.getElementById('showDate').value;
            const time = document.getElementById('showTime').value;
            const studio = document.getElementById('showStudio').value;

            if (!date || !time || !studio) {
                showToast('Mohon lengkapi semua pilihan', 'error');
                return;
            }

            document.querySelectorAll('.booking-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step2').classList.add('active');
            
            await loadSeats();
        }

        async function loadSeats() {
            const date = document.getElementById('showDate').value;
            const time = document.getElementById('showTime').value;
            const studio = document.getElementById('showStudio').value;

            showLoading('Memuat kursi...');
            
            try {
                const result = await api.getAvailableSeats(movieId, date, time, studio);
                
                hideLoading();
                
                if (result.success) {
                    displaySeats(result.seats);
                } else {
                    showToast('Gagal memuat data kursi', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Terjadi kesalahan', 'error');
                console.error('Load seats error:', error);
            }
        }

        function displaySeats(seats) {
            const container = document.getElementById('seatsContainer');
            const rows = ['A', 'B', 'C', 'D', 'E'];
            
            container.innerHTML = rows.map(row => {
                const rowSeats = seats.filter(seat => seat.number.startsWith(row));
                return `
                    <div class="seat-row">
                        <span class="row-label">${row}</span>
                        ${rowSeats.map(seat => `
                            <div class="seat ${seat.isBooked ? 'booked' : ''}" 
                                 data-seat="${seat.number}"
                                 onclick="${!seat.isBooked ? `toggleSeat('${seat.number}')` : ''}">
                                ${seat.number.substring(1)}
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');

            selectedSeats = [];
            updateSelectedSeats();
        }

        function toggleSeat(seatNumber) {
            const seatElement = document.querySelector(`[data-seat="${seatNumber}"]`);
            
            if (selectedSeats.includes(seatNumber)) {
                selectedSeats = selectedSeats.filter(s => s !== seatNumber);
                seatElement.classList.remove('selected');
            } else {
                selectedSeats.push(seatNumber);
                seatElement.classList.add('selected');
            }
            
            updateSelectedSeats();
        }

        function updateSelectedSeats() {
            document.getElementById('selectedSeatsText').textContent = 
                selectedSeats.length > 0 ? selectedSeats.join(', ') : '-';
            
            const total = selectedSeats.length * pricePerSeat;
            document.getElementById('totalPrice').textContent = formatCurrency(total);
        }

        function goToStep3() {
            if (selectedSeats.length === 0) {
                showToast('Mohon pilih kursi terlebih dahulu', 'error');
                return;
            }

            // Update summary
            const date = document.getElementById('showDate').value;
            const time = document.getElementById('showTime').value;
            const studio = document.getElementById('showStudio').value;
            
            document.getElementById('summaryMovie').textContent = currentMovie.title;
            document.getElementById('summaryDateTime').textContent = `${formatDate(date)} - ${time}`;
            document.getElementById('summaryStudio').textContent = studio;
            document.getElementById('summarySeats').textContent = selectedSeats.join(', ');
            document.getElementById('summaryTotal').textContent = formatCurrency(selectedSeats.length * pricePerSeat);

            document.querySelectorAll('.booking-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step3').classList.add('active');
        }

        async function processBooking() {
            const date = document.getElementById('showDate').value;
            const time = document.getElementById('showTime').value;
            const studio = document.getElementById('showStudio').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            showLoading('Memproses pemesanan...');
            
            try {
                const result = await api.createBooking({
                    movieId: movieId,
                    showtime: {
                        date: date,
                        time: time,
                        studio: studio
                    },
                    seats: selectedSeats,
                    paymentMethod: paymentMethod
                });
                
                hideLoading();
                
                if (result.success) {
                    showToast('Booking berhasil! Detail telah dikirim ke email Anda.', 'success');
                    setTimeout(() => {
                        window.location.href = 'my-bookings.html';
                    }, 2000);
                } else {
                    showToast(result.message || 'Booking gagal', 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('Terjadi kesalahan saat memproses booking', 'error');
                console.error('Process booking error:', error);
            }
        }
    </script>
</body>
</html>
